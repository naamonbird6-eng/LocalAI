{
 "cells": [
  {
   "cell_type": "markdown",
   "metadata": {
    "id": "xs8_Q1nPwxlK"
   },
   "source": [
    "# Structured Outputs for Multi-Agent Systems\n",
    "\n",
    "In this cookbook, we will explore how to use Structured Outputs to build multi-agent systems.\n",
    "\n",
    "Structured Outputs is a new capability that builds upon JSON mode and function calling to enforce a strict schema in a model output.\n",
    "\n",
    "By using the new parameter `strict: true`, we are able to guarantee the response abides by a provided schema.\n",
    "\n",
    "To demonstrate the power of this feature, we will use it to build a multi-agent system.\n",
    "\n",
    "### Why build a Multi-Agent System?\n",
    "\n",
    "When using function calling, if the number of functions (or tools) increases, the performance may suffer.\n",
    "\n",
    "To mitigate this, we can logically group the tools together and have specialized \"agents\" that are able to solve specific tasks or sub-tasks, which will increase the overall system performance."
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "id": "7SLTnfLRKVnP"
   },
   "source": [
    "## Environment set up"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 52,
   "metadata": {
    "id": "UCySx7jT6T7Y"
   },
   "outputs": [],
   "source": [
    "from openai import OpenAI\n",
    "from IPython.display import Image\n",
    "import json\n",
    "import pandas as pd\n",
    "import matplotlib.pyplot as plt\n",
    "from io import StringIO\n",
    "import numpy as np\n",
    "client = OpenAI()"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 53,
   "metadata": {},
   "outputs": [],
   "source": [
    "MODEL = \"gpt-4o-2024-08-06\""
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "id": "X34-4ZYyK6-S"
   },
   "source": [
    "## Agents set up\n",
    "\n",
    "The use case we will tackle is a data analysis task.\n",
    "\n",
    "Let's first set up our 4-agents system:\n",
    "\n",
    "1.   **Triaging agent:** Decides which agent(s) to call\n",
    "2.   **Data pre-processing Agent:** Prepares data for analysis - for example by cleaning it up\n",
    "3.   **Data Analysis Agent:** Performs analysis on the data\n",
    "4.   **Data Visualization Agent:** Visualizes the output of the analysis to extract insights\n",
    "\n",
    "We will start by defining the system prompts for each of these agents."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 54,
   "metadata": {
    "id": "CewlAQuhKUIe"
   },
   "outputs": [],
   "source": [
    "triaging_system_prompt = \"\"\"You are a Triaging Agent. Your role is to assess the user's query and route it to the relevant agents. The agents available are:\n",
    "- Data Processing Agent: Cleans, transforms, and aggregates data.\n",
    "- Analysis Agent: Performs statistical, correlation, and regression analysis.\n",
    "- Visualization Agent: Creates bar charts, line charts, and pie charts.\n",
    "\n",
    "Use the send_query_to_agents tool to forward the user's query to the relevant agents. Also, use the speak_to_user tool to get more information from the user if needed.\"\"\"\n",
    "\n",
    "processing_system_prompt = \"\"\"You are a Data Processing Agent. Your role is to clean, transform, and aggregate data using the following tools:\n",
    "- clean_data\n",
    "- transform_data\n",
    "- aggregate_data\"\"\"\n",
    "\n",
    "analysis_system_prompt = \"\"\"You are an Analysis Agent. Your role is to perform statistical, correlation, and regression analysis using the following tools:\n",
    "- stat_analysis\n",
    "- correlation_analysis\n",
    "- regression_analysis\"\"\"\n",
    "\n",
    "visualization_system_prompt = \"\"\"You are a Visualization Agent. Your role is to create bar charts, line charts, and pie charts using the following tools:\n",
    "- create_bar_chart\n",
    "- create_line_chart\n",
    "- create_pie_chart\"\"\""
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "id": "vkpZ409POhiS"
   },
   "source": [
    "We will then define the tools for each agent.\n",
    "\n",
    "Apart from the triaging agent, each agent will be equipped with tools specific to their role:\n",
    "\n",
    "#### Data pre-processing agent\n",
    "\n",
    "\n",
    "1.   Clean data\n",
    "2.   Transform data\n",
    "3.   Aggregate data\n",
    "\n",
    "#### Data analysis agent\n",
    "\n",
    "1.   Statistical analysis\n",
    "2.   Correlation analysis\n",
    "3.   Regression Analysis\n",
    "\n",
    "#### Data visualization agent\n",
    "\n",
    "1.   Create bar chart\n",
    "2.   Create line chart\n",
    "3.   Create pie chart"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 55,
   "metadata": {
    "id": "MzBvgBliOc9Y"
   },
   "outputs": [],
   "source": [
    "triage_tools = [\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"send_query_to_agents\",\n",
    "            \"description\": \"Sends the user query to relevant agents based on their capabilities.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"agents\": {\n",
    "                        \"type\": \"array\",\n",
    "                        \"items\": {\"type\": \"string\"},\n",
    "                        \"description\": \"An array of agent names to send the query to.\"\n",
    "                    },\n",
    "                    \"query\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The user query to send.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"agents\", \"query\"]\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    }\n",
    "]\n",
    "\n",
    "preprocess_tools = [\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"clean_data\",\n",
    "            \"description\": \"Cleans the provided data by removing duplicates and handling missing values.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The dataset to clean. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    },\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"transform_data\",\n",
    "            \"description\": \"Transforms data based on specified rules.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The data to transform. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    },\n",
    "                    \"rules\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"Transformation rules to apply, specified in a structured format.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\", \"rules\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "\n",
    "    },\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"aggregate_data\",\n",
    "            \"description\": \"Aggregates data by specified columns and operations.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The data to aggregate. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    },\n",
    "                    \"group_by\": {\n",
    "                        \"type\": \"array\",\n",
    "                        \"items\": {\"type\": \"string\"},\n",
    "                        \"description\": \"Columns to group by.\"\n",
    "                    },\n",
    "                    \"operations\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"Aggregation operations to perform, specified in a structured format.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\", \"group_by\", \"operations\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    }\n",
    "]\n",
    "\n",
    "\n",
    "analysis_tools = [\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"stat_analysis\",\n",
    "            \"description\": \"Performs statistical analysis on the given dataset.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The dataset to analyze. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    },\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"correlation_analysis\",\n",
    "            \"description\": \"Calculates correlation coefficients between variables in the dataset.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The dataset to analyze. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    },\n",
    "                    \"variables\": {\n",
    "                        \"type\": \"array\",\n",
    "                        \"items\": {\"type\": \"string\"},\n",
    "                        \"description\": \"List of variables to calculate correlations for.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\", \"variables\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    },\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"regression_analysis\",\n",
    "            \"description\": \"Performs regression analysis on the dataset.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The dataset to analyze. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    },\n",
    "                    \"dependent_var\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The dependent variable for regression.\"\n",
    "                    },\n",
    "                    \"independent_vars\": {\n",
    "                        \"type\": \"array\",\n",
    "                        \"items\": {\"type\": \"string\"},\n",
    "                        \"description\": \"List of independent variables.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\", \"dependent_var\", \"independent_vars\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    }\n",
    "]\n",
    "\n",
    "visualization_tools = [\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"create_bar_chart\",\n",
    "            \"description\": \"Creates a bar chart from the provided data.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The data for the bar chart. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    },\n",
    "                    \"x\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"Column for the x-axis.\"\n",
    "                    },\n",
    "                    \"y\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"Column for the y-axis.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\", \"x\", \"y\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    },\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"create_line_chart\",\n",
    "            \"description\": \"Creates a line chart from the provided data.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The data for the line chart. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    },\n",
    "                    \"x\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"Column for the x-axis.\"\n",
    "                    },\n",
    "                    \"y\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"Column for the y-axis.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\", \"x\", \"y\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    },\n",
    "    {\n",
    "        \"type\": \"function\",\n",
    "        \"function\": {\n",
    "            \"name\": \"create_pie_chart\",\n",
    "            \"description\": \"Creates a pie chart from the provided data.\",\n",
    "            \"parameters\": {\n",
    "                \"type\": \"object\",\n",
    "                \"properties\": {\n",
    "                    \"data\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"The data for the pie chart. Should be in a suitable format such as JSON or CSV.\"\n",
    "                    },\n",
    "                    \"labels\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"Column for the labels.\"\n",
    "                    },\n",
    "                    \"values\": {\n",
    "                        \"type\": \"string\",\n",
    "                        \"description\": \"Column for the values.\"\n",
    "                    }\n",
    "                },\n",
    "                \"required\": [\"data\", \"labels\", \"values\"],\n",
    "                \"additionalProperties\": False\n",
    "            }\n",
    "        },\n",
    "        \"strict\": True\n",
    "    }\n",
    "]"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {
    "id": "yh8tRZHkQJVv"
   },
   "source": [
    "## Tool execution\n",
    "\n",
    "We need to write the code logic to:\n",
    "- handle passing the user query to the multi-agent system\n",
    "- handle the internal workings of the multi-agent system\n",
    "- execute the tool calls\n",
    "\n",
    "For the sake of brevity, we will only define the logic for tools that are relevant to the user query."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 56,
   "metadata": {
    "id": "dwM_0mHZ5pXx"
   },
   "outputs": [],
   "source": [
    "# Example query\n",
    "\n",
    "user_query = \"\"\"\n",
    "Below is some data. I want you to first remove the duplicates then analyze the statistics of the data as well as plot a line chart.\n",
    "\n",
    "house_size (m3), house_price ($)\n",
    "90, 100\n",
    "80, 90\n",
    "100, 120\n",
    "90, 100\n",
    "\"\"\"\n"
   ]
  },
  {
   "cell_type": "markdown",
   "metadata": {},
   "source": [
    "From the user query, we can infer that the tools we would need to call are `clean_data`, `start_analysis` and `use_line_chart`.\n",
    "\n",
    "We will first define the execution function which runs tool calls.\n",
    "\n",
    "This maps a tool call to the corresponding function. It then appends the output of the function to the conversation history."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 57,
   "metadata": {
    "id": "XH6wgrATUA_l"
   },
   "outputs": [],
   "source": [
    "def clean_data(data):\n",
    "    data_io = StringIO(data)\n",
    "    df = pd.read_csv(data_io, sep=\",\")\n",
    "    df_deduplicated = df.drop_duplicates()\n",
    "    return df_deduplicated\n",
    "\n",
    "def stat_analysis(data):\n",
    "    data_io = StringIO(data)\n",
    "    df = pd.read_csv(data_io, sep=\",\")\n",
    "    return df.describe()\n",
    "\n",
    "def plot_line_chart(data):\n",
    "    data_io = StringIO(data)\n",
    "    df = pd.read_csv(data_io, sep=\",\")\n",
    "    \n",
    "    x = df.iloc[:, 0]\n",
    "    y = df.iloc[:, 1]\n",
    "    \n",
    "    coefficients = np.polyfit(x, y, 1)\n",
    "    polynomial = np.poly1d(coefficients)\n",
    "    y_fit = polynomial(x)\n",
    "    \n",
    "    plt.figure(figsize=(10, 6))\n",
    "    plt.plot(x, y, 'o', label='Data Points')\n",
    "    plt.plot(x, y_fit, '-', label='Best Fit Line')\n",
    "    plt.title('Line Chart with Best Fit Line')\n",
    "    plt.xlabel(df.columns[0])\n",
    "    plt.ylabel(df.columns[1])\n",
    "    plt.legend()\n",
    "    plt.grid(True)\n",
    "    plt.show()\n",
    "\n",
    "# Define the function to execute the tools\n",
    "def execute_tool(tool_calls, messages):\n",
    "    for tool_call in tool_calls:\n",
    "        tool_name = tool_call.function.name\n",
    "        tool_arguments = json.loads(tool_call.function.arguments)\n",
    "\n",
    "        if tool_name == 'clean_data':\n",
    "            # Simulate data cleaning\n",
    "            cleaned_df = clean_data(tool_arguments['data'])\n",
    "            cleaned_data = {\"cleaned_data\": cleaned_df.to_dict()}\n",
    "            messages.append({\"rol
